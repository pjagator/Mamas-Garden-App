<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gardening App with Plant.id & Insect.id</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background:#f9f9f9; }
header { background:#4CAF50; padding:10px; color:white; text-align:center; }
nav { display:flex; justify-content:space-around; background:#ddd; }
nav button { padding:10px; border:none; background:none; font-weight:bold; cursor:pointer; }
section { display:none; padding:20px; }
section.active { display:block; }
#camera { text-align:center; margin-top:20px; }
#id-results { background:#fff; padding:10px; border-radius:5px; margin-top:20px; }
#settings { max-width:400px; margin:auto; background:#fff; padding:20px; border-radius:8px; }
input[type=text], button { width:100%; padding:10px; margin-top:10px; box-sizing:border-box; }
button { background:#4CAF50; color:white; border:none; cursor:pointer; }
button:hover { background:#45a049; }
</style>
</head>
<body>
<header><h1>My Garden Identifier</h1></header>
<nav>
  <button onclick="showSection('capture')">Capture</button>
  <button onclick="showSection('results')">Results</button>
  <button onclick="showSection('settings')">Settings</button>
</nav>

<!-- Capture Section -->
<section id="capture" class="active">
  <h2>Take a Photo of Plants or Insects</h2>
  <p>Use your iPhone camera. Tap below to take or upload a photo.</p>
  <input type="file" accept="image/*" capture="environment" id="fileInput" onchange="handleFileInput(event)">
  <div id="prompt">After capturing, select whether it's a plant or insect, then wait for identification.</div>
</section>

<!-- Results Display -->
<section id="results">
  <h2>Identification Results</h2>
  <div id="id-results">No results yet.</div>
</section>

<!-- Settings Page -->
<section id="settings">
  <h2>API Keys Settings</h2>
  <label for="plantApiKey">Plant.id API Key:</label>
  <input type="text" id="plantApiKey" placeholder="Enter your Plant.id API Key" />
  <label for="insectApiKey">Insect.id API Key:</label>
  <input type="text" id="insectApiKey" placeholder="Enter your Insect.id API Key" />
  <button onclick="saveApiKeys()">Save API Keys</button>
</section>

<script>
function showSection(sectionId) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.getElementById(sectionId).classList.add('active');
}

// Load saved API keys on load
window.onload = () => {
  document.getElementById('plantApiKey').value = localStorage.getItem('plantApiKey') || '';
  document.getElementById('insectApiKey').value = localStorage.getItem('insectApiKey') || '';
};

// Save API keys to localStorage
function saveApiKeys() {
  localStorage.setItem('plantApiKey', document.getElementById('plantApiKey').value);
  localStorage.setItem('insectApiKey', document.getElementById('insectApiKey').value);
  alert('API keys saved!');
}

// Retrieve keys
function getApiKey(type) {
  return localStorage.getItem(type + 'ApiKey') || '';
}

// Handle file input (photo capture/upload)
function handleFileInput(event) {
  const file = event.target.files[0];
  if (!file || !file.type.startsWith('image/')) {
    alert('Please select a valid image.');
    return;
  }
  const reader = new FileReader();
  reader.onload = () => {
    const base64Image = reader.result.split(',')[1];
    // Prompt user for identification type
    const isPlant = confirm('Identify as Plant? OK for Plant, Cancel for Insect.');
    const target = isPlant ? 'plant' : 'insect';
    identifyImage(base64Image, target);
  };
  reader.readAsDataURL(file);
}

// Identification via APIs
async function identifyImage(base64Image, target) {
  const apiKey = getApiKey(target);
  if (!apiKey) {
    alert('Please enter API Key in Settings.');
    showSection('settings');
    return;
  }

  const url = target === 'plant'
    ? 'https://api.plant.id/v2/identify'
    : 'https://api.insect.id/v2/identify';

  const payload = {
    images: [base64Image],
    api_key: apiKey
  };

  // Optional organs or other fields can be added here if needed

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(errorText);
    }
    const result = await response.json();
    showResults(result, target);
  } catch (err) {
    document.getElementById('id-results').innerHTML = '<p style="color:red;">Error: ' + err.message + '</p>';
  }
}

// Show identification results
function showResults(result, target) {
  const container = document.getElementById('id-results');
  if (!result || !result.suggestions || result.suggestions.length === 0) {
    container.innerHTML = `<p>No confident matches found.</p>`;
    return;
  }
  const best = result.suggestions[0];
  if (target === 'plant') {
    container.innerHTML = `
      <h3>Plant Identification:</h3>
      <p><strong>Name:</strong> ${best.plant_name || 'Unknown'}</p>
      <p><strong>Scientific Name:</strong> ${best.plant_details?.scientific_name || 'N/A'}</p>
      <p><strong>Probability:</strong> ${(best.probability * 100).toFixed(2)}%</p>
      <p><strong>Description:</strong> ${best.plant_details?.wiki_description?.value || 'N/A'}</p>
    `;
  } else {
    container.innerHTML = `
      <h3>Insect Identification:</h3>
      <p><strong>Name:</strong> ${best.insect_name || 'Unknown'}</p>
      <p><strong>Scientific Name:</strong> ${best.insect_details?.scientific_name || 'N/A'}</p>
      <p><strong>Probability:</strong> ${(best.probability * 100).toFixed(2)}%</p>
      <p><strong>Description:</strong> ${best.insect_details?.wiki_description?.value || 'N/A'}</p>
    `;
  }
}

// Optional: About UI improvements - e.g., add a toggle or instructions

</script>
</body>
</html>
