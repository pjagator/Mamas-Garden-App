<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Florida Garden Tracker - Tampa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #2ecc71;
            --secondary: #27ae60;
            --accent: #f39c12;
            --danger: #e74c3c;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --bg: #f8f9fa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        nav {
            display: flex;
            background: var(--dark);
            padding: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        nav button {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            white-space: nowrap;
            -webkit-appearance: none;
        }

        nav button:hover, nav button:active {
            background: rgba(255,255,255,0.1);
        }

        nav button.active {
            background: var(--primary);
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .camera-section {
            text-align: center;
            padding: 20px;
            background: var(--bg);
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .camera-capture-area {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
        }

        /* iPhone-optimized file input styling */
        .camera-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
            max-width: 300px;
            margin: 10px auto;
        }

        .camera-input {
            position: absolute;
            left: -9999px;
        }

        .camera-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(46,204,113,0.3);
            -webkit-appearance: none;
        }

        .camera-button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 10px rgba(46,204,113,0.3);
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(46,204,113,0.3);
            -webkit-appearance: none;
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #captured-image {
            width: 100%;
            max-width: 500px;
            border-radius: 15px;
            margin: 20px auto;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .image-preview-container {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 500px;
        }

        .remove-image-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: none;
            z-index: 10;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .inventory-item {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
        }

        .inventory-item:active {
            transform: scale(0.98);
        }

        .inventory-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .inventory-item-info {
            padding: 15px;
        }

        .inventory-item h3 {
            color: var(--dark);
            margin-bottom: 5px;
        }

        .inventory-item p {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-right: 5px;
            margin-top: 5px;
        }

        .badge.plant {
            background: #d4f1d4;
            color: var(--secondary);
        }

        .badge.bug {
            background: #ffe4e1;
            color: var(--danger);
        }

        .badge.season {
            background: #fff4e0;
            color: var(--accent);
        }

        .timeline-container {
            background: var(--bg);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .month-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .month-card h4 {
            color: var(--primary);
            margin-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 5px;
        }

        .settings-section {
            background: #f0f8ff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            color: var(--dark);
            margin-bottom: 15px;
        }

        .api-input-group {
            margin-bottom: 15px;
        }

        .api-input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--dark);
            font-weight: 500;
        }

        .api-input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .api-input-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.85em;
        }

        .api-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .api-status.connected {
            background: #d4f1d4;
            color: var(--secondary);
        }

        .api-status.disconnected {
            background: #ffe4e1;
            color: var(--danger);
        }

        .identification-result {
            background: #e8f5e9;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .identification-loading {
            text-align: center;
            padding: 30px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        canvas {
            max-width: 100%;
            height: auto;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            margin: 50px auto;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .close-modal {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--light);
            color: var(--dark);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-appearance: none;
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .success-message {
            background: #d4f1d4;
            color: var(--secondary);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .error-message {
            background: #ffe4e1;
            color: var(--danger);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            header h1 {
                font-size: 1.8em;
            }
            
            nav {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
            
            nav button {
                flex: 0 0 auto;
                padding: 15px;
            }
            
            .content {
                padding: 20px;
            }
        }

        /* iOS-specific optimizations */
        @supports (-webkit-touch-callout: none) {
            input[type="file"] {
                font-size: 16px;
            }
            
            .camera-button {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üå∫ Florida Garden Tracker</h1>
            <p>Tampa Bay Native Plant & Wildlife Monitor</p>
        </header>

        <nav>
            <button class="active" onclick="showTab('capture')">üì∏ Capture</button>
            <button onclick="showTab('inventory')">üåø Inventory</button>
            <button onclick="showTab('timeline')">üìÖ Timeline</button>
            <button onclick="showTab('charts')">üìä Analytics</button>
            <button onclick="showTab('settings')">‚öôÔ∏è Settings</button>
        </nav>

        <div class="content">
            <!-- Capture Tab -->
            <div id="capture" class="tab-content active">
                <div class="camera-section">
                    <h2>Capture Garden Life</h2>
                    <p>Take a photo of plants or bugs in your Tampa garden</p>
                    
                    <div class="camera-capture-area">
                        <div class="image-preview-container">
                            <canvas id="captured-image"></canvas>
                            <button class="remove-image-btn" onclick="removeImage()" id="remove-btn">√ó</button>
                        </div>
                        
                        <div class="camera-input-wrapper">
                            <input type="file" 
                                   id="camera-input" 
                                   class="camera-input" 
                                   accept="image/*" 
                                   capture="environment"
                                   onchange="handlePhotoCapture(event)">
                            <label for="camera-input" class="camera-button">
                                <span>üì∑</span>
                                <span>Take Photo</span>
                            </label>
                        </div>
                        
                        <div style="margin-top: 10px;">
                            <button onclick="document.getElementById('file-upload').click()">üìÅ Upload from Gallery</button>
                            <input type="file" 
                                   id="file-upload" 
                                   accept="image/*" 
                                   style="display: none;" 
                                   onchange="handlePhotoCapture(event)">
                        </div>
                    </div>
                    
                    <div id="identify-buttons" style="display: none; margin-top: 20px;">
                        <button onclick="identifySpecies()" id="identify-btn" style="background: #3498db;">
                            üîç Identify Species
                        </button>
                    </div>
                </div>

                <div class="identification-result" id="identification-result">
                    <h3>üîç Identification Results</h3>
                    <div id="id-content"></div>
                    <button onclick="saveToInventory()" style="margin-top: 15px;">üíæ Save to Inventory</button>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div id="inventory" class="tab-content">
                <h2>Garden Inventory</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="total-plants">0</h3>
                        <p>Native Plants</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                        <h3 id="total-bugs">0</h3>
                        <p>Insects & Wildlife</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                        <h3 id="total-entries">0</h3>
                        <p>Total Entries</p>
                    </div>
                </div>

                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterInventory('all')">All</button>
                    <button class="filter-btn" onclick="filterInventory('plant')">üåø Plants</button>
                    <button class="filter-btn" onclick="filterInventory('bug')">üêõ Bugs</button>
                    <button class="filter-btn" onclick="filterInventory('blooming')">üå∫ Currently Blooming</button>
                </div>

                <div class="inventory-grid" id="inventory-grid">
                    <!-- Inventory items will be dynamically added here -->
                </div>
            </div>

            <!-- Timeline Tab -->
            <div id="timeline" class="tab-content">
                <h2>Seasonal Timeline</h2>
                <p>Track what's blooming and active throughout the year in Tampa</p>
                
                <div class="timeline-container">
                    <h3>üå∏ Blooming Calendar</h3>
                    <div class="month-grid" id="blooming-calendar">
                        <!-- Monthly data will be added here -->
                    </div>
                </div>

                <div class="timeline-container" style="margin-top: 30px;">
                    <h3>ü¶ã Wildlife Activity</h3>
                    <div class="month-grid" id="wildlife-calendar">
                        <!-- Wildlife activity data will be added here -->
                    </div>
                </div>
            </div>

            <!-- Charts Tab -->
            <div id="charts" class="tab-content">
                <h2>Garden Analytics</h2>
                
                <div class="chart-container">
                    <h3>Species Distribution</h3>
                    <canvas id="species-chart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Monthly Activity</h3>
                    <canvas id="activity-chart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Blooming Patterns</h3>
                    <canvas id="blooming-chart"></canvas>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <h2>Settings & Configuration</h2>
                
                <div class="settings-section">
                    <h3>üîë API Configuration</h3>
                    <p>Configure your Plant.id and Insect.id API keys for species identification</p>
                    
                    <div class="api-input-group">
                        <label for="plantid-key">Plant.id API Key</label>
                        <input type="password" id="plantid-key" placeholder="Enter your Plant.id API key">
                        <small>Get your key at <a href="https://plant.id" target="_blank">plant.id</a></small>
                        <span id="plantid-status" class="api-status disconnected">Not configured</span>
                    </div>
                    
                    <div class="api-input-group">
                        <label for="insectid-key">Insect.id API Key</label>
                        <input type="password" id="insectid-key" placeholder="Enter your Insect.id API key">
                        <small>Get your key at <a href="https://insect.id" target="_blank">insect.id</a></small>
                        <span id="insectid-status" class="api-status disconnected">Not configured</span>
                    </div>
                    
                    <button onclick="saveAPIKeys()">üíæ Save API Keys</button>
                    <div id="api-success" class="success-message">API keys saved successfully!</div>
                    <div id="api-error" class="error-message">Please enter valid API keys</div>
                </div>
                
                <div class="settings-section">
                    <h3>üì§ Export Data</h3>
                    <p>Download your garden data for backup or sharing</p>
                    <div style="margin-top: 15px;">
                        <button onclick="exportData()">üíæ Export as JSON</button>
                        <button onclick="exportToCSV()">üìä Export as CSV</button>
                        <button onclick="clearAllData()" style="background: var(--danger);">üóëÔ∏è Clear All Data</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>üåø Native Florida Plants Database</h3>
                    <p>Pre-loaded database of common native Florida plants</p>
                    <button onclick="showFloridaPlants()">View Plant Database</button>
                </div>

                <div class="settings-section">
                    <h3>üì± About This App</h3>
                    <p><strong>Florida Garden Tracker v2.0</strong></p>
                    <p>Designed for Tampa Bay gardeners to track native plants and local wildlife.</p>
                    <p style="margin-top: 10px;"><strong>Features:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>iPhone-optimized camera capture</li>
                        <li>Plant.id & Insect.id integration</li>
                        <li>Seasonal tracking for Tampa climate</li>
                        <li>Offline data storage</li>
                        <li>Export capabilities</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for item details -->
    <div id="item-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // Florida Native Plants Database
        const floridaNativePlants = [
            { name: "Coontie", scientific: "Zamia integrifolia", bloom: ["Spring", "Summer"], type: "Cycad" },
            { name: "Beautyberry", scientific: "Callicarpa americana", bloom: ["Summer", "Fall"], type: "Shrub" },
            { name: "Firebush", scientific: "Hamelia patens", bloom: ["Spring", "Summer", "Fall"], type: "Shrub" },
            { name: "Wild Coffee", scientific: "Psychotria nervosa", bloom: ["Spring", "Summer"], type: "Shrub" },
            { name: "Simpson's Stopper", scientific: "Myrcianthes fragrans", bloom: ["Spring", "Summer"], type: "Tree" },
            { name: "Blanket Flower", scientific: "Gaillardia pulchella", bloom: ["Spring", "Summer", "Fall"], type: "Wildflower" },
            { name: "Beach Sunflower", scientific: "Helianthus debilis", bloom: ["Year-round"], type: "Wildflower" },
            { name: "Coral Honeysuckle", scientific: "Lonicera sempervirens", bloom: ["Spring", "Summer", "Fall"], type: "Vine" },
            { name: "Passion Vine", scientific: "Passiflora incarnata", bloom: ["Summer", "Fall"], type: "Vine" },
            { name: "Muhly Grass", scientific: "Muhlenbergia capillaris", bloom: ["Fall"], type: "Grass" },
            { name: "Saw Palmetto", scientific: "Serenoa repens", bloom: ["Spring"], type: "Palm" },
            { name: "Cabbage Palm", scientific: "Sabal palmetto", bloom: ["Summer"], type: "Palm" },
            { name: "Southern Magnolia", scientific: "Magnolia grandiflora", bloom: ["Spring", "Summer"], type: "Tree" },
            { name: "Live Oak", scientific: "Quercus virginiana", bloom: ["Spring"], type: "Tree" },
            { name: "Bald Cypress", scientific: "Taxodium distichum", bloom: ["Spring"], type: "Tree" }
        ];

        // Database initialization
        let db;
        let currentIdentification = null;
        let chartJsLoaded = typeof Chart !== 'undefined';

        // Initialize IndexedDB
        function initDB() {
            try {
                const request = indexedDB.open('GardenTrackerDB', 1);
                
                request.onerror = function() {
                    console.error("Database failed to open");
                    alert("Unable to open database. The app may not save data properly.");
                };
                
                request.onsuccess = function() {
                    db = request.result;
                    console.log("Database opened successfully");
                    loadInventory();
                    updateStats();
                    initializeCalendars();
                    loadAPIKeys();
                };
                
                request.onupgradeneeded = function(e) {
                    db = e.target.result;
                    
                    if (!db.objectStoreNames.contains('inventory')) {
                        const objectStore = db.createObjectStore('inventory', { keyPath: 'id', autoIncrement: true });
                        objectStore.createIndex('type', 'type', { unique: false });
                        objectStore.createIndex('date', 'date', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
            } catch (error) {
                console.error("Error initializing database:", error);
            }
        }

        // Tab navigation
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('nav button');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            buttons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'charts') {
                updateCharts();
            }
        }

        // Photo handling for iPhone optimization
        function handlePhotoCapture(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    displayCapturedImage(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        function displayCapturedImage(imageSrc) {
            const canvas = document.getElementById('captured-image');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Resize image to reasonable size while maintaining aspect ratio
                const maxWidth = 800;
                const maxHeight = 800;
                let width = img.width;
                let height = img.height;
                
                if (width > height) {
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.style.display = 'block';
                document.getElementById('remove-btn').style.display = 'block';
                document.getElementById('identify-buttons').style.display = 'block';
            };
            
            img.src = imageSrc;
        }

        function removeImage() {
            const canvas = document.getElementById('captured-image');
            canvas.style.display = 'none';
            document.getElementById('remove-btn').style.display = 'none';
            document.getElementById('identify-buttons').style.display = 'none';
            document.getElementById('identification-result').style.display = 'none';
            
            // Clear file inputs
            document.getElementById('camera-input').value = '';
            document.getElementById('file-upload').value = '';
        }

        // API Key Management
        function saveAPIKeys() {
            const plantIdKey = document.getElementById('plantid-key').value;
            const insectIdKey = document.getElementById('insectid-key').value;
            
            if (!plantIdKey || !insectIdKey) {
                document.getElementById('api-error').style.display = 'block';
                document.getElementById('api-success').style.display = 'none';
                return;
            }
            
            const transaction = db.transaction(['settings'], 'readwrite');
            const objectStore = transaction.objectStore('settings');
            
            objectStore.put({ key: 'plantIdKey', value: plantIdKey });
            objectStore.put({ key: 'insectIdKey', value: insectIdKey });
            
            document.getElementById('api-success').style.display = 'block';
            document.getElementById('api-error').style.display = 'none';
            
            // Update status indicators
            document.getElementById('plantid-status').className = 'api-status connected';
            document.getElementById('plantid-status').textContent = 'Connected';
            document.getElementById('insectid-status').className = 'api-status connected';
            document.getElementById('insectid-status').textContent = 'Connected';
            
            setTimeout(() => {
                document.getElementById('api-success').style.display = 'none';
            }, 3000);
        }

        function loadAPIKeys() {
            const transaction = db.transaction(['settings'], 'readonly');
            const objectStore = transaction.objectStore('settings');
            
            objectStore.get('plantIdKey').onsuccess = function(event) {
                if (event.target.result) {
                    document.getElementById('plantid-key').value = event.target.result.value;
                    document.getElementById('plantid-status').className = 'api-status connected';
                    document.getElementById('plantid-status').textContent = 'Connected';
                }
            };
            
            objectStore.get('insectIdKey').onsuccess = function(event) {
                if (event.target.result) {
                    document.getElementById('insectid-key').value = event.target.result.value;
                    document.getElementById('insectid-status').className = 'api-status connected';
                    document.getElementById('insectid-status').textContent = 'Connected';
                }
            };
        }

        // Species Identification using Plant.id or Insect.id
        async function identifySpecies() {
            const canvas = document.getElementById('captured-image');
            if (!canvas || canvas.style.display === 'none') {
                alert('Please capture or upload a photo first');
                return;
            }
            
            // Get API keys
            const transaction = db.transaction(['settings'], 'readonly');
            const objectStore = transaction.objectStore('settings');
            
            const plantKeyRequest = objectStore.get('plantIdKey');
            const insectKeyRequest = objectStore.get('insectIdKey');
            
            plantKeyRequest.onsuccess = async function() {
                insectKeyRequest.onsuccess = async function() {
                    const plantKey = plantKeyRequest.result?.value;
                    const insectKey = insectKeyRequest.result?.value;
                    
                    if (!plantKey || !insectKey) {
                        alert('Please configure your API keys in Settings first');
                        return;
                    }
                    
                    // Show loading state
                    const resultDiv = document.getElementById('identification-result');
                    const contentDiv = document.getElementById('id-content');
                    resultDiv.style.display = 'block';
                    contentDiv.innerHTML = `
                        <div class="identification-loading">
                            <div class="spinner"></div>
                            <p>Analyzing image with AI...</p>
                            <p style="font-size: 0.9em; color: #666;">This may take 10-15 seconds</p>
                        </div>
                    `;
                    
                    // Disable identify button during processing
                    const identifyBtn = document.getElementById('identify-btn');
                    identifyBtn.disabled = true;
                    
                    // Convert canvas to base64
                    const imageData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                    
                    try {
                        // First try Plant.id
                        let identification = await tryPlantId(imageData, plantKey);
                        
                        // If no plant found or low confidence, try Insect.id
                        if (!identification || identification.confidence < 30) {
                            const insectResult = await tryInsectId(imageData, insectKey);
                            if (insectResult && insectResult.confidence > (identification?.confidence || 0)) {
                                identification = insectResult;
                            }
                        }
                        
                        if (identification) {
                            currentIdentification = identification;
                            displayIdentification(identification);
                        } else {
                            throw new Error('Could not identify the species');
                        }
                        
                    } catch (error) {
                        console.error('Identification error:', error);
                        contentDiv.innerHTML = `
                            <p style="color: red;">‚ùå Error during identification</p>
                            <p>${error.message}</p>
                            <button onclick="simulateIdentification()" style="margin-top: 10px;">Try Simulated ID</button>
                        `;
                    } finally {
                        identifyBtn.disabled = false;
                    }
                };
            };
        }

        async function tryPlantId(imageData, apiKey) {
            try {
                const response = await fetch('https://api.plant.id/v3/identification', {
                    method: 'POST',
                    headers: {
                        'Api-Key': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        images: [imageData],
                        plant_details: ['common_names', 'scientific_name', 'structured_name', 'watering'],
                        plant_language: 'en',
                        modifiers: ['crops_fast', 'similar_images']
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Plant.id API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.suggestions && data.suggestions.length > 0) {
                    const suggestion = data.suggestions[0];
                    const commonNames = suggestion.plant_details?.common_names || [];
                    const commonName = commonNames.length > 0 ? commonNames[0] : suggestion.plant_name;
                    
                    // Check if it's a Florida native
                    const floridaPlant = floridaNativePlants.find(plant => 
                        suggestion.plant_details?.scientific_name?.toLowerCase().includes(plant.scientific.toLowerCase()) ||
                        commonName.toLowerCase().includes(plant.name.toLowerCase())
                    );
                    
                    return {
                        type: 'plant',
                        common: floridaPlant?.name || commonName,
                        scientific: suggestion.plant_details?.scientific_name || 'Unknown',
                        category: floridaPlant?.type || 'Plant',
                        confidence: Math.round(suggestion.probability * 100),
                        description: `Identified with ${Math.round(suggestion.probability * 100)}% confidence`,
                        care: suggestion.plant_details?.watering?.max ? 
                            `Water ${suggestion.plant_details.watering.max} times per week` : 
                            'Care information not available',
                        bloom: floridaPlant?.bloom || null,
                        isNative: !!floridaPlant,
                        source: 'Plant.id'
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Plant.id error:', error);
                return null;
            }
        }

        async function tryInsectId(imageData, apiKey) {
            try {
                const response = await fetch('https://api.insect.id/v2/identification', {
                    method: 'POST',
                    headers: {
                        'Api-Key': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        images: [imageData],
                        similar_images: true,
                        modifiers: ['crops_fast']
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Insect.id API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.suggestions && data.suggestions.length > 0) {
                    const suggestion = data.suggestions[0];
                    const commonName = suggestion.insect_details?.common_names?.[0] || suggestion.name;
                    
                    return {
                        type: 'bug',
                        common: commonName,
                        scientific: suggestion.insect_details?.scientific_name || suggestion.name,
                        category: 'Insect/Wildlife',
                        confidence: Math.round(suggestion.probability * 100),
                        description: `${commonName} - Common in Florida gardens`,
                        season: ['Year-round'], // Most Florida insects are active year-round
                        source: 'Insect.id'
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Insect.id error:', error);
                return null;
            }
        }

        function displayIdentification(identification) {
            const contentDiv = document.getElementById('id-content');
            
            let badgeColor = identification.isNative ? 'style="background: #d4f1d4; color: green;"' : '';
            let nativeBadge = identification.isNative ? '<span class="badge" style="background: gold; color: #333;">üåü Florida Native!</span>' : '';
            
            contentDiv.innerHTML = `
                <p><strong>Common Name:</strong> ${identification.common}</p>
                <p><strong>Scientific Name:</strong> <em>${identification.scientific}</em></p>
                <p><strong>Type:</strong> ${identification.type === 'plant' ? 'üåø' : 'üêõ'} ${identification.type}</p>
                <p><strong>Category:</strong> ${identification.category}</p>
                <p><strong>Confidence:</strong> ${identification.confidence}%</p>
                ${nativeBadge}
                ${identification.bloom ? `<p><strong>Blooming Season:</strong> ${identification.bloom.join(', ')}</p>` : ''}
                ${identification.season ? `<p><strong>Active Season:</strong> ${identification.season.join(', ')}</p>` : ''}
                <p><strong>Description:</strong> ${identification.description}</p>
                ${identification.care ? `<p><strong>Care Tips:</strong> ${identification.care}</p>` : ''}
                <p style="margin-top: 10px; font-size: 0.9em; color: #666;">üîç Identified using ${identification.source}</p>
            `;
        }

        // Simulated identification fallback
        function simulateIdentification() {
            const isPlant = Math.random() > 0.5;
            let identification;
            
            if (isPlant) {
                const plant = floridaNativePlants[Math.floor(Math.random() * floridaNativePlants.length)];
                identification = {
                    type: 'plant',
                    common: plant.name,
                    scientific: plant.scientific,
                    category: plant.type,
                    bloom: plant.bloom,
                    description: `Native Florida ${plant.type.toLowerCase()}. Blooms in ${plant.bloom.join(', ')}.`,
                    care: 'Drought-tolerant once established. Prefers full to partial sun.',
                    confidence: Math.floor(Math.random() * 30) + 70,
                    source: 'Simulation'
                };
            } else {
                const bugs = [
                    { name: "Zebra Longwing", scientific: "Heliconius charithonia", season: ["Year-round"] },
                    { name: "Gulf Fritillary", scientific: "Agraulis vanillae", season: ["Spring", "Summer", "Fall"] },
                    { name: "Green Anole", scientific: "Anolis carolinensis", season: ["Year-round"] },
                    { name: "Lubber Grasshopper", scientific: "Romalea microptera", season: ["Summer", "Fall"] }
                ];
                const bug = bugs[Math.floor(Math.random() * bugs.length)];
                identification = {
                    type: 'bug',
                    common: bug.name,
                    scientific: bug.scientific,
                    category: 'Insect',
                    season: bug.season,
                    description: `Common in Tampa gardens. Active ${bug.season.join(', ')}.`,
                    confidence: Math.floor(Math.random() * 30) + 70,
                    source: 'Simulation'
                };
            }
            
            currentIdentification = identification;
            displayIdentification(identification);
            document.getElementById('identification-result').style.display = 'block';
        }

        // Save to inventory
        function saveToInventory() {
            if (!currentIdentification) {
                alert('Please identify an item first');
                return;
            }
            
            const canvas = document.getElementById('captured-image');
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            const entry = {
                ...currentIdentification,
                image: imageData,
                date: new Date().toISOString(),
                notes: ''
            };
            
            const transaction = db.transaction(['inventory'], 'readwrite');
            const objectStore = transaction.objectStore('inventory');
            const request = objectStore.add(entry);
            
            request.onsuccess = function() {
                alert('Added to inventory!');
                loadInventory();
                updateStats();
                removeImage();
                currentIdentification = null;
            };
        }

        // Load inventory
        function loadInventory() {
            const transaction = db.transaction(['inventory'], 'readonly');
            const objectStore = transaction.objectStore('inventory');
            const request = objectStore.getAll();
            
            request.onsuccess = function() {
                const items = request.result;
                displayInventory(items);
            };
        }

        // Display inventory
        function displayInventory(items) {
            const grid = document.getElementById('inventory-grid');
            grid.innerHTML = '';
            
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'inventory-item';
                div.onclick = () => showItemDetails(item);
                
                div.innerHTML = `
                    <img src="${item.image}" alt="${item.common}">
                    <div class="inventory-item-info">
                        <h3>${item.common}</h3>
                        <p><em>${item.scientific}</em></p>
                        <span class="badge ${item.type}">${item.type === 'plant' ? 'üåø' : 'üêõ'} ${item.type}</span>
                        ${item.bloom ? `<span class="badge season">üå∏ ${item.bloom.join(', ')}</span>` : ''}
                        ${item.season ? `<span class="badge season">üìÖ ${item.season.join(', ')}</span>` : ''}
                    </div>
                `;
                
                grid.appendChild(div);
            });
        }

        // Filter inventory
        function filterInventory(filter) {
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const transaction = db.transaction(['inventory'], 'readonly');
            const objectStore = transaction.objectStore('inventory');
            let request;
            
            if (filter === 'all') {
                request = objectStore.getAll();
            } else if (filter === 'plant' || filter === 'bug') {
                const index = objectStore.index('type');
                request = index.getAll(filter);
            } else if (filter === 'blooming') {
                request = objectStore.getAll();
            }
            
            request.onsuccess = function() {
                let items = request.result;
                
                if (filter === 'blooming') {
                    const currentMonth = new Date().getMonth();
                    const seasons = ['Winter', 'Spring', 'Summer', 'Fall'];
                    const currentSeason = seasons[Math.floor((currentMonth + 1) / 3) % 4];
                    
                    items = items.filter(item => 
                        item.bloom && (item.bloom.includes(currentSeason) || item.bloom.includes('Year-round'))
                    );
                }
                
                displayInventory(items);
            };
        }

        // Show item details
        function showItemDetails(item) {
            const modal = document.getElementById('item-modal');
            const modalBody = document.getElementById('modal-body');
            
            modalBody.innerHTML = `
                <img src="${item.image}" style="width: 100%; border-radius: 10px; margin-bottom: 20px;">
                <h2>${item.common}</h2>
                <p><strong>Scientific Name:</strong> <em>${item.scientific}</em></p>
                <p><strong>Type:</strong> ${item.category}</p>
                <p><strong>Date Added:</strong> ${new Date(item.date).toLocaleDateString()}</p>
                ${item.confidence ? `<p><strong>ID Confidence:</strong> ${item.confidence}%</p>` : ''}
                ${item.description ? `<p><strong>Description:</strong> ${item.description}</p>` : ''}
                ${item.care ? `<p><strong>Care Tips:</strong> ${item.care}</p>` : ''}
                ${item.bloom ? `<p><strong>Blooming Season:</strong> ${item.bloom.join(', ')}</p>` : ''}
                ${item.season ? `<p><strong>Active Season:</strong> ${item.season.join(', ')}</p>` : ''}
                ${item.isNative ? '<p><span class="badge" style="background: gold; color: #333;">üåü Florida Native!</span></p>' : ''}
                <button onclick="deleteItem(${item.id})" style="background: var(--danger); margin-top: 20px;">Delete Entry</button>
            `;
            
            modal.style.display = 'block';
        }

        // Close modal
        function closeModal() {
            document.getElementById('item-modal').style.display = 'none';
        }

        // Delete item
        function deleteItem(id) {
            if (confirm('Are you sure you want to delete this entry?')) {
                const transaction = db.transaction(['inventory'], 'readwrite');
                const objectStore = transaction.objectStore('inventory');
                const request = objectStore.delete(id);
                
                request.onsuccess = function() {
                    closeModal();
                    loadInventory();
                    updateStats();
                };
            }
        }

        // Update statistics
        function updateStats() {
            const transaction = db.transaction(['inventory'], 'readonly');
            const objectStore = transaction.objectStore('inventory');
            const request = objectStore.getAll();
            
            request.onsuccess = function() {
                const items = request.result;
                const plants = items.filter(item => item.type === 'plant').length;
                const bugs = items.filter(item => item.type === 'bug').length;
                
                document.getElementById('total-plants').textContent = plants;
                document.getElementById('total-bugs').textContent = bugs;
                document.getElementById('total-entries').textContent = items.length;
            };
        }

        // Initialize calendars
        function initializeCalendars() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            
            const bloomingCalendar = document.getElementById('blooming-calendar');
            const wildlifeCalendar = document.getElementById('wildlife-calendar');
            
            months.forEach((month, index) => {
                const bloomCard = document.createElement('div');
                bloomCard.className = 'month-card';
                bloomCard.innerHTML = `<h4>${month}</h4><div id="bloom-${index}"></div>`;
                bloomingCalendar.appendChild(bloomCard);
                
                const wildlifeCard = document.createElement('div');
                wildlifeCard.className = 'month-card';
                wildlifeCard.innerHTML = `<h4>${month}</h4><div id="wildlife-${index}"></div>`;
                wildlifeCalendar.appendChild(wildlifeCard);
            });
            
            updateCalendars();
        }

        // Update calendars
        function updateCalendars() {
            const transaction = db.transaction(['inventory'], 'readonly');
            const objectStore = transaction.objectStore('inventory');
            const request = objectStore.getAll();
            
            request.onsuccess = function() {
                const items = request.result;
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
                
                months.forEach((month, index) => {
                    const season = getSeason(index);
                    
                    const bloomingPlants = items.filter(item => 
                        item.type === 'plant' && item.bloom && 
                        (item.bloom.includes(season) || item.bloom.includes('Year-round'))
                    );
                    
                    const bloomDiv = document.getElementById(`bloom-${index}`);
                    if (bloomDiv) {
                        bloomDiv.innerHTML = bloomingPlants.length > 0 
                            ? bloomingPlants.map(p => `<p>üå∏ ${p.common}</p>`).join('')
                            : '<p style="color: #999;">No data yet</p>';
                    }
                    
                    const activeWildlife = items.filter(item => 
                        item.type === 'bug' && item.season && 
                        (item.season.includes(season) || item.season.includes('Year-round'))
                    );
                    
                    const wildlifeDiv = document.getElementById(`wildlife-${index}`);
                    if (wildlifeDiv) {
                        wildlifeDiv.innerHTML = activeWildlife.length > 0
                            ? activeWildlife.map(w => `<p>ü¶ã ${w.common}</p>`).join('')
                            : '<p style="color: #999;">No data yet</p>';
                    }
                });
            };
        }

        function getSeason(monthIndex) {
            if (monthIndex >= 2 && monthIndex <= 4) return 'Spring';
            if (monthIndex >= 5 && monthIndex <= 7) return 'Summer';
            if (monthIndex >= 8 && monthIndex <= 10) return 'Fall';
            return 'Winter';
        }

        // Update charts
        function updateCharts() {
            if (!chartJsLoaded) {
                console.warn('Chart.js not loaded');
                return;
            }
            
            const transaction = db.transaction(['inventory'], 'readonly');
            const objectStore = transaction.objectStore('inventory');
            const request = objectStore.getAll();
            
            request.onsuccess = function() {
                const items = request.result;
                
                // Clear existing charts
                const canvases = ['species-chart', 'activity-chart', 'blooming-chart'];
                canvases.forEach(id => {
                    const canvas = document.getElementById(id);
                    const parent = canvas.parentElement;
                    canvas.remove();
                    const newCanvas = document.createElement('canvas');
                    newCanvas.id = id;
                    parent.appendChild(newCanvas);
                });
                
                // Species Distribution Chart
                const speciesCtx = document.getElementById('species-chart').getContext('2d');
                new Chart(speciesCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Plants', 'Insects & Wildlife'],
                        datasets: [{
                            data: [
                                items.filter(i => i.type === 'plant').length,
                                items.filter(i => i.type === 'bug').length
                            ],
                            backgroundColor: ['#2ecc71', '#f39c12']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
                
                // Monthly Activity Chart
                const activityCtx = document.getElementById('activity-chart').getContext('2d');
                const monthlyData = Array(12).fill(0);
                items.forEach(item => {
                    const month = new Date(item.date).getMonth();
                    monthlyData[month]++;
                });
                
                new Chart(activityCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{
                            label: 'Entries Added',
                            data: monthlyData,
                            backgroundColor: '#3498db'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
                
                // Blooming Patterns Chart
                const bloomCtx = document.getElementById('blooming-chart').getContext('2d');
                const seasons = ['Spring', 'Summer', 'Fall', 'Winter'];
                const bloomData = seasons.map(season => 
                    items.filter(i => i.bloom && i.bloom.includes(season)).length
                );
                
                new Chart(bloomCtx, {
                    type: 'radar',
                    data: {
                        labels: seasons,
                        datasets: [{
                            label: 'Blooming Plants',
                            data: bloomData,
                            backgroundColor: 'rgba(46, 204, 113, 0.2)',
                            borderColor: '#2ecc71',
                            pointBackgroundColor: '#2ecc71'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            };
        }

        // Export functions
        function exportData() {
            const transaction = db.transaction(['inventory'], 'readonly');
            const objectStore = transaction.objectStore('inventory');
            const request = objectStore.getAll();
            
            request.onsuccess = function() {
                const data = {
                    version: '2.0',
                    exportDate: new Date().toISOString(),
                    location: 'Tampa, FL',
                    entries: request.result
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `garden-tracker-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            };
        }

        function exportToCSV() {
            const transaction = db.transaction(['inventory'], 'readonly');
            const objectStore = transaction.objectStore('inventory');
            const request = objectStore.getAll();
            
            request.onsuccess = function() {
                const items = request.result;
                let csv = 'Common Name,Scientific Name,Type,Category,Date Added,Confidence,Bloom Season,Active Season,Florida Native\n';
                
                items.forEach(item => {
                    csv += `"${item.common}","${item.scientific}","${item.type}","${item.category}",`;
                    csv += `"${new Date(item.date).toLocaleDateString()}",`;
                    csv += `"${item.confidence || 'N/A'}%",`;
                    csv += `"${item.bloom ? item.bloom.join(', ') : ''}",`;
                    csv += `"${item.season ? item.season.join(', ') : ''}",`;
                    csv += `"${item.isNative ? 'Yes' : 'No'}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `garden-tracker-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };
        }

        function clearAllData() {
            if (confirm('Are you sure you want to delete all data? This cannot be undone.')) {
                const transaction = db.transaction(['inventory'], 'readwrite');
                const objectStore = transaction.objectStore('inventory');
                const request = objectStore.clear();
                
                request.onsuccess = function() {
                    alert('All data has been cleared');
                    loadInventory();
                    updateStats();
                    updateCalendars();
                };
            }
        }

        function showFloridaPlants() {
            const modal = document.getElementById('item-modal');
            const modalBody = document.getElementById('modal-body');
            
            let html = '<h2>Native Florida Plants Database</h2>';
            html += '<p>Common plants suitable for Tampa Bay gardens:</p>';
            
            floridaNativePlants.forEach(plant => {
                html += `
                    <div style="padding: 10px; margin: 10px 0; background: #f0f8ff; border-radius: 10px;">
                        <h4>${plant.name}</h4>
                        <p><em>${plant.scientific}</em></p>
                        <p>Type: ${plant.type}</p>
                        <p>Blooms: ${plant.bloom.join(', ')}</p>
                    </div>
                `;
            });
            
            modalBody.innerHTML = html;
            modal.style.display = 'block';
        }

        // Initialize app
        window.onload = function() {
            try {
                initDB();
                console.log("Florida Garden Tracker v2.0 initialized");
            } catch (error) {
                console.error("Error during app initialization:", error);
            }
        };

        // Handle window click for modal
        window.onclick = function(event) {
            const modal = document.getElementById('item-modal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };

        // Error handler
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
        });
    </script>
</body>
</html>
